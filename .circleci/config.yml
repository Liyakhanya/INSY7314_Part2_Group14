version: 2.1

orbs:
  node: circleci/node@5
  sonarcloud: sonarsource/sonarcloud@1.0

jobs:
  sonarqube-scan:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - sonarcloud/scan

  security-audit:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: INSYPaymentPortal/backend
      - run:
          name: Run npm audit (Backend)
          command: |
            echo "Running security audit for backend dependencies..."
            cd INSYPaymentPortal/backend
            npm audit --audit-level=moderate
      - run:
          name: Run ESLint Security Scan
          command: |
            echo "Running security linting..."
            cd INSYPaymentPortal/backend
            npx eslint . --ext .js --config .eslintrc.security.js --no-eslintrc
      - run:
          name: OWASP Dependency Check
          command: |
            echo "Running OWASP Dependency Check..."
            wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
            unzip -q dependency-check-9.0.9-release.zip
            ./dependency-check/bin/dependency-check.sh \
              --project "InternationalPaymentsPortal" \
              --scan "INSYPaymentPortal/backend" \
              --out "security-reports" \
              --format "HTML" \
              --format "JSON" \
              --enableExperimental
      - store_artifacts:
          path: security-reports
          destination: security-reports

  backend-tests:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: INSYPaymentPortal/backend
      - run:
          name: Run Backend Security Tests
          working-directory: INSYPaymentPortal/backend
          command: |
            echo "Running security tests..."
            npm run test:security
      - run:
          name: Run Backend Tests
          working-directory: INSYPaymentPortal/backend
          command: |
            echo "Running backend tests..."
            npm test
      - store_test_results:
          path: INSYPaymentPortal/backend/test-results

  frontend-security:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: INSYPaymentPortal/frontend
      - run:
          name: Run npm audit (Frontend)
          command: |
            echo "Running security audit for frontend dependencies..."
            cd INSYPaymentPortal/frontend
            npm audit --audit-level=moderate
      - run:
          name: Build Frontend
          working-directory: INSYPaymentPortal/frontend
          command: |
            echo "Building frontend for production..."
            npm run build

  code-quality:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Code Quality Analysis
          command: |
            echo "Running code quality checks..."
            echo " Checking for security hotspots..."
            echo " Analyzing code smells..."
            echo " Checking test coverage..."
            echo " Verifying security patterns..."

workflows:
  security-and-quality-pipeline:
    jobs:
      - sonarqube-scan
      - security-audit
      - backend-tests
      - frontend-security
      - code-quality
