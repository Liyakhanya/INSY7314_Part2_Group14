version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@1.0.6
  node: circleci/node@5.1.0

jobs:
  test-backend:
    docker:
      - image: cimg/node:18.17.0
    working_directory: ~/project/server
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
          working-directory: server
      - run:
          name: Run backend security audit
          working_directory: server
          command: npm audit --audit-level=moderate
      - run:
          name: Run backend tests (if any)
          working_directory: server
          command: |
            if [ -f package.json ] && npm run | grep -q test; then
              npm test
            else
              echo "No tests configured"
            fi

  test-frontend:
    docker:
      - image: cimg/node:18.17.0
    working_directory: ~/project/client
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
          working-directory: client
      - run:
          name: Run frontend security audit
          working_directory: client
          command: npm audit --audit-level=moderate
      - run:
          name: Run frontend tests (if any)
          working_directory: client
          command: |
            if [ -f package.json ] && npm run | grep -q test; then
              npm test
            else
              echo "No tests configured"
            fi

  sonar-scan:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - sonarcloud/scan

workflows:
  quality-check:
    jobs:
      - test-backend
      - test-frontend
      - sonar-scan:
          requires:
            - test-backend
            - test-frontend
          context: sonarcloud
